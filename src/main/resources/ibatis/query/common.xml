<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="randy.web.common">

	<typeAlias alias="category" type="randy.web.domain.Category"/>
	<typeAlias alias="categoryTag" type="randy.web.domain.CategoryTag"/>
	
	<cacheModel id="categoryCache" type="LRU">
		<flushInterval minutes="10" />
		<flushOnExecute statement="randy.web.common.insertCate"/>
	</cacheModel>
	
	<cacheModel id="categoryTagCache" type="LRU" >
		<flushInterval minutes="10" />
		<flushOnExecute statement="randy.web.common.insertCategoryTag"/>
	</cacheModel>	
	
	<sql id="selectCategorySql">
				cate_id   AS cateId
			,	cate_name AS cateName
			,	pcate_id  AS pcateId
			,	use_yn    AS useYn
	</sql>
	
	<select id="getCateList" resultClass="category" parameterClass="category" cacheModel="categoryCache">
		SELECT <include refid="selectCategorySql"/>
		FROM tb_category
		<dynamic prepend="WHERE">
			<isGreaterThan prepend="AND" property="pcateId" compareValue="0">
				pcate_id = #pcateId#
			</isGreaterThan>
		</dynamic>			
	</select>
	
	<insert id="insertCateList" parameterClass="category">
		INSERT INTO tb_category (
				cate_name
			,	pcate_id
			,	use_yn
		) vaLUES (
				#cateName#
			,	#pcateId#
			,	#useYn#
		)
		<selectKey keyProperty="cateId" resultClass="java.lang.Integer">
        	SELECT LAST_INSERT_ID()
		</selectKey>			
	</insert>
	
	<select id="selectCategoryTagSql">
			,	A.cate_id   AS cateId
			,	A.cate_name AS cateName
			,	A.pcate_id  AS pcateId
			,	B.seq       AS seq
			,	B.tag       AS tag
	</select>
	
	<select id="getCateTagList" resultClass="categoryTag" parameterClass="categoryTag" cacheModel="categoryTagCache">
		SELECT <include refid="selectCategoryTagSql"/>
		FROM tb_category 
		LEFT JOIN tb_category_tag
		ON tb_category.cate_id = tb_category_tag.cate_id
		<dynamic prepend="WHERE">
			<isGreaterThan prepend="AND" property="pcateId" compareValue="0">
				tb_category.pcate_id = #pcateId#
			</isGreaterThan>
		</dynamic>			
	</select>
	
	<insert id="insertCategoryTag" parameterClass="categoryTag">
		INSERT INTO tb_category_tag (
				pcate_id
			,	tag
		) VALUES (
				#pcateId#
			,	#tag#
		)
		<selectKey keyProperty="seq" resultClass="java.lang.Integer">
        	SELECT LAST_INSERT_ID()
		</selectKey>		
	</insert>
	
	<update id="updateategoryTag" parameterClass="categoryTag">
		UPDATE tb_category_tag SET
				pcate_id = #appNm#
			,	tag = #tag#
		WHERE seq = #seq#
	</update>
	
	<delete id="deleteCategoryTag" parameterClass="categoryTag">
		DELETE FROM tb_category_tag
		WHERE seq = #seq#
	</delete>
	

</sqlMap>
